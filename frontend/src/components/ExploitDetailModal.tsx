import { useEffect } from 'react'
import './ExploitDetailModal.css'

interface Exploit {
  id: string
  cve_id: string
  title: string
  description: string
  exploit_content: string
  exploit_type: string
  severity: string
  source?: string
  source_type: string
  target_models?: string[]
  mitigation?: string
  status: string
  discovered_date?: string
  created_at: string
}

interface ExploitDetailModalProps {
  exploit: Exploit
  onClose: () => void
  onDelete?: (id: string) => void
}

export default function ExploitDetailModal({ exploit, onClose, onDelete }: ExploitDetailModalProps) {
  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose()
    }
    window.addEventListener('keydown', handleEscape)
    return () => window.removeEventListener('keydown', handleEscape)
  }, [onClose])

  useEffect(() => {
    document.body.style.overflow = 'hidden'
    return () => {
      document.body.style.overflow = 'unset'
    }
  }, [])

  const handleDelete = () => {
    if (confirm(`Are you sure you want to delete ${exploit.cve_id}?`)) {
      onDelete?.(exploit.id)
      onClose()
    }
  }

  const formatDate = (dateString?: string) => {
    if (!dateString) return 'Unknown'
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    })
  }

  return (
    <div className="exploit-detail-overlay" onClick={onClose}>
      <div className="exploit-detail-modal" onClick={(e) => e.stopPropagation()}>
        <button className="exploit-detail-close" onClick={onClose} aria-label="Close">
          âœ•
        </button>

        <div className="exploit-detail-header">
          <div className="exploit-detail-title-row">
            <h2>{exploit.cve_id}</h2>
            <span className={`severity-badge severity-${exploit.severity}`}>
              {exploit.severity.toUpperCase()}
            </span>
          </div>
          <h3>{exploit.title}</h3>
        </div>

        <div className="exploit-detail-content">
          <div className="detail-section">
            <h4>Description</h4>
            <p>{exploit.description}</p>
          </div>

          <div className="detail-section">
            <h4>Exploit Content</h4>
            <div className="exploit-code">
              <pre>{exploit.exploit_content}</pre>
            </div>
          </div>

          <div className="detail-grid">
            <div className="detail-item">
              <span className="detail-label">Type</span>
              <span className="detail-value">{exploit.exploit_type}</span>
            </div>
            <div className="detail-item">
              <span className="detail-label">Status</span>
              <span className="detail-value">{exploit.status}</span>
            </div>
            <div className="detail-item">
              <span className="detail-label">Source</span>
              <span className="detail-value">{exploit.source || 'Unknown'}</span>
            </div>
            <div className="detail-item">
              <span className="detail-label">Source Type</span>
              <span className="detail-value">{exploit.source_type}</span>
            </div>
            <div className="detail-item">
              <span className="detail-label">Discovered</span>
              <span className="detail-value">{formatDate(exploit.discovered_date)}</span>
            </div>
            <div className="detail-item">
              <span className="detail-label">Added</span>
              <span className="detail-value">{formatDate(exploit.created_at)}</span>
            </div>
          </div>

          {exploit.target_models && exploit.target_models.length > 0 && (
            <div className="detail-section">
              <h4>Target Models</h4>
              <div className="model-tags">
                {exploit.target_models.map((model, idx) => (
                  <span key={idx} className="model-tag">{model}</span>
                ))}
              </div>
            </div>
          )}

          {exploit.mitigation && (
            <div className="detail-section">
              <h4>Mitigation</h4>
              <p>{exploit.mitigation}</p>
            </div>
          )}

          <div className="exploit-detail-actions">
            <button className="btn-delete" onClick={handleDelete}>
              Delete Exploit
            </button>
            <button className="btn-close" onClick={onClose}>
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}
